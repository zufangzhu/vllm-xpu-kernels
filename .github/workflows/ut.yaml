name: run unit tests on Intel GPU.

on: 
  pull_request:
  push:
    branches: [main]

permissions: 
  contents: read

jobs:
  run-unit-tests-pvc:
    runs-on: self-hosted-pvc
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: build docker image
        run: |
          cp -r "$HOME/umd" ./umd
          docker build -t xpu-kernel-ci-image -f Dockerfile.xpu .

      - name: test 
        run: |
          docker run \
          --device /dev/dri \
          -v /dev/dri/by-path:/dev/dri/by-path \
          --privileged \
          --name vllm-xpu-kernel-ci \
          xpu-kernel-ci-image \
          /bin/bash -c '
          ZE_AFFINITY_MASK=0 SKIP_HANG_KERNEL=1 pytest -v -s /workspace/vllm-xpu-kernels/tests/
          VLLM_XPU_FORCE_XE_DEFAULT_KERNEL=1 pytest -v -s /workspace/vllm-xpu-kernels/tests/fused_moe/test_grouped_gemm.py::test_grouped_gemm
          '
      - name: Remove container
        if: ${{ always() }} 
        run: |
          docker rm -f vllm-xpu-kernel-ci || true
          docker image rm -f vllm-xpu-kernel-ci || true
          docker system prune -f || true

  run-unit-tests-bmg:
    runs-on: self-hosted-bmg
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: build docker image
        run: |
          cp -r "$HOME/umd" ./umd
          docker build -t xpu-kernel-ci-image -f Dockerfile.xpu .

      - name: test 
        run: |
          docker run \
          --device /dev/dri \
          -v /dev/dri/by-path:/dev/dri/by-path \
          --privileged \
          --name vllm-xpu-kernel-ci \
          xpu-kernel-ci-image \
          /bin/bash -c '
          ZE_AFFINITY_MASK=0,1 pytest -v -s /workspace/vllm-xpu-kernels/tests/ --ignore=/workspace/vllm-xpu-kernels/tests/test_lora_ops.py --ignore=/workspace/vllm-xpu-kernels/tests/test_fp8_quant.py
          # fixme: Running lora UT separately to avoid OOM when running together with other tests.
          ZE_AFFINITY_MASK=0,1 pytest -v -s /workspace/vllm-xpu-kernels/tests/test_lora_ops.py
          VLLM_XPU_FORCE_XE_DEFAULT_KERNEL=1 pytest -v -s /workspace/vllm-xpu-kernels/tests/fused_moe/test_grouped_gemm.py::test_grouped_gemm
          '
      - name: Remove container
        if: ${{ always() }} 
        run: |
          docker rm -f vllm-xpu-kernel-ci || true
          docker image rm -f vllm-xpu-kernel-ci || true
          docker system prune -f || true
